extends ../../layouts/default.pug
include ../../mixins/filterStatus.pug
include ../../mixins/search.pug

block main
    .col-lg-10
        .main-content#mainContent(role="main")
            section#products-section.content-section
                .card.filter-card.mb-3
                    .card-header.d-flex.justify-content-between.align-items-center
                        h5.mb-0
                            i.fas.fa-filter.mr-2
                            | Bộ lọc & Tìm kiếm
                    .card-body
                        .d-flex.flex-wrap.align-items-center.w-100
                            //- Nhóm nút lọc trạng thái
                            .btn-group.btn-group-sm(role="group" aria-label="Lọc theo trạng thái")
                                +filter-status(filterStatus)

                        //- Tìm kiếm (GET). Giữ lại status hiện tại (nếu có).
                        +search(keyword)
                .card
                    .card-header.d-flex.justify-content-between.align-items-center
                        h5.mb-0
                            i.fas.fa-box.mr-2
                            | Danh sách sản phẩm
                        .d-flex.align-items-center
                            button#addBtn.btn.btn-primary.btn-glow(type="button")
                                i.fas.fa-plus.mr-2
                                | Thêm sản phẩm

                .card
                    .card-body
                        .table-responsive
                            table#productsTable.table.table-hover(aria-describedby="Danh sách sản phẩm")
                                thead.thead-dark
                                    tr
                                        th STT
                                        th Hình ảnh
                                        th(data-sort="name" role="button" tabindex="0" aria-label="Sắp xếp theo tiêu đề")
                                            | Tiêu đề
                                            i.fas.fa-sort.ml-1
                                        th(data-sort="price" role="button" tabindex="0" aria-label="Sắp xếp theo giá")
                                            | Giá
                                            i.fas.fa-sort.ml-1
                                        th Trạng thái
                                        th Hành động
                                tbody#productsTableBody
                                    each p, idx in products
                                        tr(data-id=p._id)
                                            td #{idx + 1}
                                            td
                                                // Ảnh 60x60, object-fit: cover (dùng class, không inline style)
                                                img.img-thumbnail.thumb-60-cover(src=p.thumbnail, alt=`${p.title} thumbnail 100x100 SEO`)
                                            td
                                                strong= p.title
                                            td= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(p.price)
                                            td
                                                if p.status === 'active'
                                                    span.badge.badge-success.badge-pulse Hoạt động
                                                else
                                                    span.badge.badge-danger.badge-pulse Dừng hoạt động
                                            td
                                                a.btn.btn-warning.btn-sm.btn-glow(
                                                href=`/${prefixAdmin}/products/edit/${p._id}`
                                                aria-label=`Sửa sản phẩm ${p.title}`
                                                )
                                                    i.fas.fa-edit.mr-1
                                                    | Sửa
                                                form.d-inline(method="POST", action=`/${prefixAdmin}/products/delete/${p._id}?_method=DELETE`)
                                                    button.btn.btn-danger.btn-sm.btn-glow(
                                                        type="submit"
                                                        onclick="return confirm('Bạn có chắc chắn muốn xóa?')"
                                                        aria-label=`Xóa sản phẩm ${p.title}`
                                                    )
                                                        i.fas.fa-trash.mr-1
                                                        | Xóa
                                                a.btn.btn-info.btn-sm.btn-glow.ml-1(
                                                href=`/${prefixAdmin}/products/${p._id}/sync`
                                                aria-label=`Cập nhật sản phẩm ${p.title}`
                                                )
                                                    i.fas.fa-sync.mr-1
                                                    | Cập nhật
                        //- Pagination
                        - const cp = pagination.currentPage || 1
                        - const tp = pagination.totalPages || 1
                        - const win = 2
                        - let start = Math.max(1, cp - win)
                        - let end = Math.min(tp, cp + win)
                        - if (start > 1 && (end - start) < win * 2) { start = Math.max(1, end - win * 2) }
                        - if (end < tp && (end - start) < win * 2) { end = Math.min(tp, start + win * 2) }

                        if tp > 1
                        nav.pagination-wrapper(aria-label="Phân trang")
                            ul.pagination.pagination-modern.justify-content-center(
                                data-current-page=cp
                                data-total-pages=tp
                            )
                                //- Prev
                                li.page-item(class=cp === 1 ? 'disabled' : '')
                                    button.page-link(
                                        type="button"
                                        aria-label="Trang trước"
                                        button-pagination=(cp - 1)
                                    )
                                        i.fas.fa-angle-left

                                //- First + ellipsis
                                if start > 1
                                    li.page-item
                                        button.page-link(type="button" button-pagination=1 aria-label="Trang 1") 1
                                    if start > 2
                                        li.page-item.disabled
                                            span.page-link &hellip;

                                //- Window
                                - for (let i = start; i <= end; i++)
                                    li.page-item(class=i === cp ? 'active' : '')
                                        button.page-link(
                                            type="button"
                                            button-pagination=i
                                            aria-current=(i === cp ? 'page' : false)
                                            aria-label=`Trang ${i}`
                                        ) #{i}

                                //- Ellipsis + last
                                if end < tp
                                    if end < tp - 1
                                        li.page-item.disabled
                                            span.page-link &hellip;
                                    li.page-item
                                        button.page-link(type="button" button-pagination=tp aria-label=`Trang ${tp}`) #{tp}

                                //- Next
                                li.page-item(class=cp === tp ? 'disabled' : '')
                                    button.page-link(
                                        type="button"
                                        aria-label="Kế tiếp"
                                        button-pagination=(cp + 1)
                                    )
                                        i.fas.fa-angle-right
