extends ../../layouts/default.pug
//- include ../../mixins/filterStatus.pug
//- include ../../mixins/search.pug
//- include ../../mixins/pagination.pug
//- include ../../mixins/form-change-multi.pug
include ../../mixins/alert.pug
//- include ../../mixins/sort.pug
include ../../mixins/deny-access.pug
include ../../mixins/moment.pug

block main
    .col-lg-10
        .main-content#mainContent(role="main")
            if(authRole.permissions.includes('accounts_view'))
                +alert-success(5000)
                section#products-section.content-section
                    //- .card.filter-card.mb-3
                    //-     .card-header.d-flex.justify-content-between.align-items-center
                    //-         h5.mb-0
                    //-             i.fas.fa-filter.mr-2
                    //-             | Bộ lọc & Tìm kiếm
                    //-     .card-body
                    //-         .d-flex.flex-wrap.align-items-center.w-100
                    //-             //- Nhóm nút lọc trạng thái
                    //-             .btn-group.btn-group-sm(role="group" aria-label="Lọc theo trạng thái")
                    //-                 +filter-status(filterStatus)

                    //-         //- Tìm kiếm (GET). Giữ lại status hiện tại (nếu có).
                    //-         +search(keyword)

                    //-         +sort(sort) 
                    .card
                        .card-header.d-flex.justify-content-between.align-items-center
                            h5.mb-0
                                i.fas.fa-box.mr-2
                                | #{pageTitle}
                            .d-flex.align-items-center
                                if(authRole.permissions.includes('accounts_create'))
                                    a#addBtn.btn.btn-primary.btn-glow(
                                        href= `/${prefixAdmin}/accounts/create`
                                    )
                                        i.fas.fa-plus.mr-2
                                        | Thêm tài khoản

                    .card
                        .card-body
                            .table-responsive
                                //- +form-change-multi(
                                //-     `/${prefixAdmin}/accounts/change-multi?_method=PATCH`
                                //- )
                                table(
                                    class="table table-hover table-sm"
                                    checkbox-multi
                                )
                                    thead.thead-dark
                                        tr
                                            //- th 
                                            //-     input(
                                            //-         type="checkbox"
                                            //-         name="checkall"
                                            //-     ) 
                                            th STT
                                            th Avatar
                                            th Họ tên
                                            th Phân quyền
                                            th Email
                                            th Trạng thái
                                            th Người tạo
                                            th Hành động
                                    tbody#productsTableBody
                                        each account, idx in records
                                            tr(data-id=account._id)
                                                //- td
                                                //-     input(
                                                //-         type="checkbox"
                                                //-         name="ids"
                                                //-         value=account._id
                                                //-     )
                                                //- td #{pagination.limitItems*(pagination.currentPage -1) + (idx + 1)}
                                                td #{idx + 1}
                                                td
                                                    // Ảnh 60x60, object-fit: cover (dùng class, không inline style)
                                                    img.img-thumbnail.thumb-60-cover(src=account.avatar, alt=`${account.fullName} thumbnail 100x100 SEO`)
                                                td
                                                    strong= account.fullName
                                                td #{account.role.title}
                                                td #{account.email}
                                                td
                                                    if(authRole.permissions.includes('accounts_edit'))
                                                        if account.status === 'active'
                                                            a.badge.badge-success.badge-pulse(
                                                                data-status = account.status
                                                                data-id = account._id 
                                                                button-change-status
                                                            ) Hoạt động
                                                        else
                                                            a.badge.badge-danger.badge-pulse(
                                                                data-status = account.status
                                                                data-id = account._id 
                                                                button-change-status
                                                            ) Dừng hoạt động
                                                    else 
                                                        if account.status === 'active'
                                                            span.badge.badge-success.badge-pulse(
                                                                data-status = account.status
                                                                data-id = account._id
                                                            ) Hoạt động
                                                        else
                                                            span.badge.badge-danger.badge-pulse(
                                                                data-status = account.status
                                                                data-id = account._id
                                                            ) Dừng hoạt động
                                                td
                                                    if account.accountFullName
                                                        p= account.accountFullName
                                                    if account.createdBy && account.createdBy.createdAt
                                                        +formatDate(account.createdBy.createdAt)
                                                    else if account.createdAt
                                                        +formatDate(account.createdAt)
                                                    else
                                                        span.text-muted Chưa có
                                                td
                                                    if(authRole.permissions.includes('accounts_view'))
                                                        a.btn.btn-secondary.btn-sm.btn-glow(
                                                            href=`/${prefixAdmin}/accounts/detail/${account._id}`
                                                            aria-label=`Xem chi tiết tài khoản ${account.fullName}`
                                                        )
                                                            i.fas.fa-eye.mr-1
                                                            | Chi tiết
                                                    if(authRole.permissions.includes('accounts_edit'))
                                                        a.btn.btn-warning.btn-sm.btn-glow(
                                                        href=`/${prefixAdmin}/accounts/edit/${account._id}`
                                                        aria-label=`Sửa tài khoản ${account.fullName}`
                                                        )
                                                            i.fas.fa-edit.mr-1
                                                            | Sửa
                                                    if(authRole.permissions.includes('accounts_delete'))
                                                        form.d-inline(method="POST", action=`/${prefixAdmin}/accounts/delete/${account._id}?_method=DELETE`)
                                                            button.btn.btn-danger.btn-sm.btn-glow(
                                                                type="button"
                                                                button-delete
                                                                aria-label=`Xóa tài khoản ${account.fullName}`
                                                            )
                                                                i.fas.fa-trash.mr-1
                                                                | Xóa
                            //- Pagination
                            //- +pagination(pagination)

                            form(
                                action= ""
                                method="POST"
                                id = "form-change-status"
                                data-path = `/${prefixAdmin}/accounts/change-status`
                            ) 

                            form(
                                action= ""
                                method="POST"
                                id = "form-delete-item"
                                data-path = `/${prefixAdmin}/accounts/delete`
                            ) 

                    script(src="/admin/js/product.js")
            else 
                +deny-access()